<?php
if (!isset($_SESSION)) {
    session_start();
}

require_once "db/connection.php";

if (!isset($_SESSION["logged_in"]) || $_SESSION["logged_in"] != true) {
    require_once "process/auth-check.php";
}

$loggedIn = isset($_SESSION["logged_in"]) ? $_SESSION["logged_in"] : false;
$userRole = isset($_SESSION["active_account_type"]) ? $_SESSION["active_account_type"] : "";
$userId = isset($_SESSION["user_id"]) ? $_SESSION["user_id"] : "";

if (!$loggedIn) {
    header("Location: index.php");
    exit();
}

if (strtolower($userRole) != "seller") {
    header("Location: home.php");
    exit();
}

$productId = intval($_GET["id"] ?? 0);
if ($productId <= 0)  header("Location: seller-dashboard.php");

$productResult = Database::search(
    "SELECT * FROM product WHERE id = ? AND seller_id = ?",
    "ii",
    [$productId, $userId]
);
if (!$productResult || $productResult->num_rows  == 0)  header("Location: seller-dashboard.php");
$product = $productResult->fetch_assoc();


// fetch categories from database
$categoryResult = Database::search("SELECT `id`,`name`  FROM `category` ORDER BY `name`");
$categories = [];


if ($categoryResult && $categoryResult->num_rows > 0) {
    while ($category = $categoryResult->fetch_assoc()) {
        $categories[] = $category;
    }
}


$successMsg = ($_GET["success"]) ?? "";
$errorMsg = ($_GET["error"]) ?? "";




require "header.php";

?>


<div class="min-h-screen bg-gray-50 py-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:p-8">

        <!------Header------>
        <div class="mb-8">
            <a href="seller-dashboard.php" class="text-blue-600 hover:text-sm font-medium mb-4 inline-block">
                ⬅️ Back To Dashboard
            </a>
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Edit Product</h1>
            <p class="text-lg text-gray-600">Update your product listing details</p>
        </div>

        <!--Success error mewssage-->
        <?php if (!empty($successMsg)): ?>
            <div id="alertBox" class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                <p class="text-green-800"><strong>Success!</strong> Your product has been updated successfully</p>
            </div>
        <?php endif; ?>


        <?php if (!empty($errorMsg)): ?>
            <div id="alertBox" class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                <p class="text-red-800"><strong>Error :</strong> <?php echo ($errorMsg); ?></p>
            </div>
        <?php endif; ?>

        <!-- edit form -->
        <div class="bg-white rounded-lg shadow-mb-1 overflow-hidden">
            <form id="productForm" enctype="multipart/form-data" class="p-8">

                <!--product title--------------------- -->
                <div class="mb-6">
                    <label for="producttitle" class="block-text-sm font-medium text-gray-700 mb-2">
                        Product Title <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="producttitle" name="producttitle" placeholder="Enter Product Title"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500
                            focus:border-transparent outline-none transition"
                        value="<?php echo $product["title"]; ?>" />
                    <p class="text-xs text-gray-500 mt-1">Max 150 characteres</p>
                </div>

                <!--Discription--------------------------->
                <div class="mb-6">
                    <label for="description" class="block-text-sm font-medium text-gray-700 mb-2">
                        Product Description <span class="text-red-500">*</span>
                    </label>
                    <textarea name="description" id="description" rows="5" placeholder="Describe your product in details..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
                        maxlength="1000"><?php echo htmlspecialchars($product["description"]); ?></textarea>
                    <p class="text-xs text-gray-500 mt-1">Max 1000 characters</p>
                </div>

                <!--Two column layout --------------------------->
                <div class="grid grid-cols-1 md:grid-cols-2  gap-6 mb-6">

                    <!-- Category--------------------------------------->
                    <div>
                        <label for="category" class="block-text-sm font-medium text-gray-700 mb-2">
                            Category <span class="text-red-500">*</span>
                        </label>
                        <select name="category" id="category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
                            <option value="0">Select Your category</option>

                            <?php foreach ($categories as $category): ?>
                                <option value="<?php echo $category["id"]; ?>" <?php echo ($category["id"] == $product["category_id"]) ? "selected" : ""; ?>>
                                    <?php echo $category["name"]; ?>
                                </option>
                            <?php endforeach; ?>

                        </select>
                    </div>

                    <!--Price ------------------------------------->
                    <div>
                        <label for="price" class="block-text-sm font-medium text-gray-700 mb-2">
                            Price (RS) <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <span class="absolute left-2 top-2 text-gray-600">Rs.</span>
                            <input type="number" id="price" name="price" placeholder="0.00" min="0" step="0.01"
                                class="w-full px-8 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500
                            focus:border-transparent outline-none transition" maxlength="1000"
                                value="<?php echo $product["price"]; ?>" />
                        </div>
                    </div>

                </div>



                <!--Two column layout -->
                <div class="grid grid-cols-1 md:grid-cols-2  gap-6 mb-6">

                    <!-- level--------------------------------->
                    <div>
                        <label for="level" class="block-text-sm font-medium text-gray-700 mb-2">
                            Level <span class="text-red-500">*</span>
                        </label>
                        <select name="level" id="level" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500
                                                               focus:border-transparent outline-none transition">
                            <option value="0">Select Your level</option>
                            <option value="Beginner" <?php echo ($product["level"] == "Beginner") ? " selected" : ""; ?>>Beginner</option>
                            <option value="Intermediate" <?php echo ($product["level"] == "Intermediate") ? " selected" : ""; ?>>Intermediate</option>
                            <option value="Advanced" <?php echo ($product["level"] == "Advanced") ? " selected" : ""; ?>>Advanced</option>
                        </select>
                    </div>

                    <!-- status----------------------------------->
                    <div>
                        <label for="status" class="block-text-sm font-medium text-gray-700 mb-2">
                            Status <span class="text-red-500">*</span>
                        </label>
                        <select name="status" id="status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500
                                                               focus:border-transparent outline-none transition">
                            <option value="0">Select Your status</option>
                            <option value="Active" <?php echo ($product["status"] == "Active") ? " selected" : ""; ?>>Active</option>
                            <option value="Inactive" <?php echo ($product["status"] == "Inactive") ? " selected" : ""; ?>>Inactive</option>
                        </select>
                    </div>

                </div>

                <!--product image-------------------------------------- -->
                <div class="mb-8">
                    <label for="productimage" class="block-text-sm font-medium text-gray-700 mb-2">
                        Product Image (optional - Leave empty to keep current image)
                    </label>

                    <!-- current image ---------------------------------->
                    <?php if (!empty($product["image_url"])): ?>
                        <div class="mb-6">
                            <p class="text-sm text-gray-600 mb-2">Current Image:</p>
                            <img src="<?php echo $product["image_url"]; ?>" class="max-w-xs h-auto rounded-lg shadow-md" />
                        </div>
                    <?php endif; ?>

                    <!--upload era----------------------------------- -->
                    <div id="uploadArea" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer
                     hover:border-blue-500 hover:bg-blue-50 transition-colors">
                        <svg class="mx-auto h-12 w-12 text-gray-400 mb-2" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20a4 4 0 004 4h24a4 4 0 004-4V20m-6-8l-6-6m0 0l-6 6m6-6v12"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <p class="text-gray-700 font-medium mb-1">Drag adnd drop your Image hear</p>
                        <p class="text-gray-700 text-sm mb-4">click to select a file</p>
                        <p class="text-gray-700 text-xs">PNG , JPG up to 5MB</p>
                    </div>
                    <input type="file" id="productImage" name="productimage" accept="image/*" class="hidden" />

                    <!--Image preview------------------------------>
                    <div id="imagePreview" class="mt-6 hidden">
                        <img id="previewImg" src="" alt="preview" class="max-w-xs h-auto rounded-lg shadow-md mb-4" />
                        <button type="button" id="removeImage" class="px-4 py-2 bg-red-500 text-white rounded-lg
                            hover:bg-red-600 transition-colors">Remove Image</button>
                    </div>
                </div>


                <!-- error message ------------------------>
                <div id="form-message" class="mb-6 p-4 rounded-lg hidden"></div>

                <!--Submit button ------------------------------->
                <div class="flex gap-4 ">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold py-3 rounded-lg
                       hover:from-blue-700 hover:to-indigo-700 transition-all transform hover:scale-105">update Product</button>
                    <a href="seller-dashboard.php" class="flex-1 bg-gray-300 text-gray-800 font-semibold py-3 rounded-lg hover:bg-gray-400 transition-colors
                       text-center">Cancel</a>
                </div>



            </form>
        </div>

    </div>

</div>



<script>
    const uploadArea = document.getElementById("uploadArea");
    const fileInput = document.getElementById("productImage");
    const imagePreview = document.getElementById("imagePreview");
    const previewImg = document.getElementById("previewImg");
    const removeImage = document.getElementById("removeImage");
    const productForm = document.getElementById("productForm");
    const formMessage = document.getElementById("form-message");

    //upload area click
    uploadArea.addEventListener("click", () => [fileInput.click()]);


    // file input chenge
    fileInput.addEventListener("change", (e) => handlefileSelect(e.target.files[0]));

    //drag and drop
    uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("border-blue-500", "bg-blue-50");
    });
    uploadArea.addEventListener("dragleave", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("border-blue-500", "bg-blue-50");
    });
    uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("border-blue-500", "bg-blue-50");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(files[0]);
            fileInput.files = dataTransfer.files;

            handlefileSelect(files[0]);
        }
    });


    function handlefileSelect(file) {


        //validate file type
        if (!file.type.startsWith("image/")) {
            showerror("Please select a valid image file.");
            return;
        }

        //validate file size (5Mb max)
        const maxsize = 5 * 1024 * 1024;
        if (file.size > maxsize) {
            showerror("image size must be less than 5MB.");
            return;
        }

        //create preview
        const reader = new FileReader();
        reader.onload = (e) => {
            previewImg.src = e.target.result;
            imagePreview.classList.remove("hidden");
            uploadArea.classList.add("hidden");
            formMessage.classList.add("hidden");

        };
        reader.readAsDataURL(file);
    }


    //remove image

    removeImage.addEventListener("click", () => {
        fileInput.value = "";
        imagePreview.classList.add("hidden");
        uploadArea.classList.remove("hidden");
        previewImg.src = "";
    });



    // form submit
    productForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const productTitleValue = document.getElementById("producttitle").value;
        const description = document.getElementById("description").value;
        const category = document.getElementById("category").value;
        const price = parseFloat(document.getElementById("price").value);
        const level = document.getElementById("level").value;
        const status = document.getElementById("status").value;
        const image = fileInput.files[0];

        // Validation Logic
        if (!productTitleValue) {
            showError("Please enter a product title.");
        } else if (productTitleValue.length > 150) {
            showError("Product title must be less than 150 characters.");
        } else if (!description) {
            showError("Please enter a product description.");
        } else if (description.length > 1000) {
            showError("Product description must be less than 1000 characters.");
        } else if (category === "0") {
            showError("Please select a category.");
        } else if (!price || price <= 0) {
            showError("Please enter a valid price.");
        } else if (level == "0") {
            showError("Please select a level.");
        } else if (status == "0") {
            showError("Please select a status.");
        } else {

            const formData = new FormData();
            formData.append("productId", "<?php echo $productId; ?>");

            formData.append("producttitle", productTitleValue);
            formData.append("description", description);
            formData.append("category", category);
            formData.append("price", price);
            formData.append("level", level);
            formData.append("status", status);
            formData.append("productimage", image);

            try {
                const response = await fetch("process/product-UpdateProcess.php", {
                    method: "POST",
                    body: formData
                });

                const result = await response.text();

                if (result.trim() == "success") {
                    window.location.href = "product-edit.php?id=<?php echo $productId; ?>&success=product updated successfully";
                } else {
                    showError(result);
                }

            } catch (error) {
                showError("An error occurred while submitting the form. Please try again.");
                console.error("Form submission error:", error);
            }
        }
    });

    //show error message
    function showError(message) {
        formMessage.textContent = message;
        formMessage.className = "p-4 rounded-lg bg-red-50 border border-red-200 text-red-800 mb-6";
        formMessage.classList.remove("hidden");
        window.scrollTo({
            top: formMessage.offsetTop - 100,
            behavior: "smooth"
        });
    }

    //show success message  
    function showSuccess(message) {
        formMessage.textContent = message;
        formMessage.className = "p-4 rounded-lg bg-green-50 border border-green-200 text-green-800 mb-6";
        formMessage.classList.remove("hidden");
        window.scrollTo({
            top: formMessage.offsetTop - 100,
            behavior: "smooth"
        });
    }

    //reset message
    function resetMessage(element) {
        setTimeout(() => {
            window.location.href = "product-edit.php?id=<?php echo $productId; ?>";
        }, 4000);
    }


    //reset alert box
    const alertBox = document.getElementById("alertBox");
    if (alertBox) {
        setTimeout(() => {
            window.location.href = "product-edit.php?id=<?php echo $productId; ?>";
        }, 4000);
    }
</script>
































<?php require "footer.php"; ?>